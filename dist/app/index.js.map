{"version":3,"sources":["../../src/app/index.js"],"names":["App","connections","jackrabbit","amqp","mongoose","mongo","on","_onConnected","bind","rabbit","db","events","queue","name","prefetch","durabe","_onReady","emit","log","data","publish","key","self","consume","job","ack","eventName","type","count","event","save","err","EventEmitter"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;kBA6Fe,YAAW;AACzB,QAAO,IAAIA,GAAJ,EAAP;AACA,C;;AA/FD;;;;AAEA;;;;AACA;;;;AAEA;;;;AAEA;;;;;;IAEMA,G;;;AACL,gBAAc;AAAA;;AAAA;;AAGb,QAAKC,WAAL,GAAmB,yBAAY;AAC9BC,eAAY,iBAAOD,WAAP,CAAmBE,IADD;AAE9BC,aAAU,iBAAOH,WAAP,CAAmBI;AAFC,GAAZ,CAAnB;;AAKA,QAAKJ,WAAL,CAAiBK,EAAjB,CAAoB,OAApB,EAA6B,MAAKC,YAAL,CAAkBC,IAAlB,OAA7B;;AAEA,QAAKC,MAAL,GAAc,EAAd;AACA,QAAKC,EAAL;AAXa;AAYb;;AAED;;;;iCAEe;;AAEd;AACA,QAAKD,MAAL,CAAYE,MAAZ,GAAqB,KAAKV,WAAL,CAAiBW,KAAjB,CAAuBA,KAAvB,CAA6B;AACjDC,UAAM,YAD2C;AAEjDC,cAAU,CAFuC;AAGjDC,YAAQ;AAHyC,IAA7B,CAArB;;AAMA,QAAKN,MAAL,CAAYC,EAAZ,GAAiB,KAAKT,WAAL,CAAiBW,KAAjB,CAAuBA,KAAvB,CAA6B;AAC7CC,UAAM,SADuC;AAE7CC,cAAU,CAFmC;AAG7CC,YAAQ;AAHqC,IAA7B,CAAjB;;AAMA;AACA,QAAKL,EAAL,GAAU,KAAKT,WAAL,CAAiBS,EAA3B;;AAGA,QAAKM,QAAL;AACA;;;6BAEU;AACV,QAAKC,IAAL,CAAU,OAAV;AACA,oBAAOC,GAAP,CAAW,MAAX,EAAmB,aAAnB;AACA;;;4BAES;AACT,QAAKD,IAAL,CAAU,MAAV;AACA,oBAAOC,GAAP,CAAW,MAAX,EAAmB,oBAAnB;AACA;;AAED;AACC;;;;wBAEKC,I,EAAM;AACX,QAAKlB,WAAL,CAAiBW,KAAjB,CAAuBQ,OAAvB,CAA+BD,IAA/B,EAAqC,EAACE,KAAK,YAAN,EAArC;AACA;;;4BAES;AAAA;;AACT,OAAIC,OAAO,IAAX;;AAEA,QAAKb,MAAL,CAAYE,MAAZ,CAAmBY,OAAnB,CAA2B,UAACC,GAAD,EAAMC,GAAN,EAAc;AACxC,QAAIC,YAAYF,IAAIG,IAAJ,IAAY,cAA5B;AACA,QAAIC,QAAQ,CAAZ;;AAEA,WAAK3B,WAAL,CAAiBW,KAAjB,CAAuBQ,OAAvB,CAA+BI,GAA/B,EAAoC,EAACH,KAAK,cAAN,EAApC;AACA,WAAKpB,WAAL,CAAiBW,KAAjB,CAAuBQ,OAAvB,CAA+BI,GAA/B,EAAoC,EAACH,KAAK,SAAN,EAApC;;AAEAI;AACA,IARD;;AAUA,QAAKhB,MAAL,CAAYC,EAAZ,CAAea,OAAf,CAAuB,UAACC,GAAD,EAAMC,GAAN,EAAc;AACpC,QAAII,QAAQ,yBAAUL,GAAV,CAAZ;AACAK,UAAMC,IAAN,CAAW,eAAO;AACjB,SAAIC,GAAJ,EAAS;AACR,uBAAOb,GAAP,CAAW,MAAX,EAAmB,gBAAnB,EAAqCa,GAArC;AACA;AACA,MAHD,MAGO;AACN,uBAAOb,GAAP,CAAW,MAAX,EAAmB,0BAAnB,EAA+CM,GAA/C;AACAC;AACA;AACD,KARD;AASA,IAXD;AAYA;;;EAjFgB,iBAAOO,Y","file":"index.js","sourcesContent":["import events from 'events';\r\n\r\nimport connections from './connector';\r\nimport logger from '../modules/logger';\r\n\r\nimport config from '../config';\r\n\r\nimport Event from './EventModel';\r\n\r\nclass App extends events.EventEmitter {\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.connections = connections({\r\n\t\t\tjackrabbit: config.connections.amqp,\r\n\t\t\tmongoose: config.connections.mongo\r\n\t\t});\r\n\r\n\t\tthis.connections.on('ready', this._onConnected.bind(this));\r\n\r\n\t\tthis.rabbit = {};\r\n\t\tthis.db;\r\n\t}\r\n\r\n\t// 'Private' methods.\r\n\r\n\t_onConnected() {\r\n\r\n\t\t// Setup jackrabbit queues.\r\n\t\tthis.rabbit.events = this.connections.queue.queue({\r\n\t\t\tname: 'jobs.event',\r\n\t\t\tprefetch: 5,\r\n\t\t\tdurabe: true\r\n\t\t});\r\n\r\n\t\tthis.rabbit.db = this.connections.queue.queue({\r\n\t\t\tname: 'jobs.db',\r\n\t\t\tprefetch: 5,\r\n\t\t\tdurabe: true\r\n\t\t});\r\n\r\n\t\t// Reference mongoose connection.\r\n\t\tthis.db = this.connections.db;\r\n\r\n\r\n\t\tthis._onReady();\r\n\t}\r\n\r\n\t_onReady() {\r\n\t\tthis.emit('ready');\r\n\t\tlogger.log('info', 'App: Ready!')\r\n\t}\r\n\r\n\t_onLost() {\r\n\t\tthis.emit('lost');\r\n\t\tlogger.log('info', 'App: Disconnected.');\r\n\t}\r\n\r\n\t// 'Public' methods.\r\n\t\t// process event (pass msg data to queue for worker)\r\n\r\n\tqueue(data) {\r\n\t\tthis.connections.queue.publish(data, {key: 'jobs.event'});\r\n\t}\r\n\r\n\tprocess() {\r\n\t\tlet self = this;\r\n\r\n\t\tthis.rabbit.events.consume((job, ack) => {\r\n\t\t\tlet eventName = job.type || 'unclassified';\r\n\t\t\tlet count = 2;\r\n\r\n\t\t\tthis.connections.queue.publish(job, {key: 'jobs.tracker'});\r\n\t\t\tthis.connections.queue.publish(job, {key: 'jobs.db'});\r\n\r\n\t\t\tack();\r\n\t\t});\r\n\r\n\t\tthis.rabbit.db.consume((job, ack) => {\r\n\t\t\tlet event = new Event(job);\r\n\t\t\tevent.save(err => {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tlogger.log('warn', 'App: db error.', err);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tlogger.log('info', 'App: db processed event.', job);\r\n\t\t\t\t\tack();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport default function() {\r\n\treturn new App();\r\n}"]}